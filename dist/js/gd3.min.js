function mutation_matrix(t){function e(t){t.each(function(e){function n(t,e,n,r,a){function i(t,e){if(t.snid in s){var n=s[t.snid].genes.map(function(t){return t.gene});e.genes.forEach(function(e){-1==n.indexOf(e.gene)&&s[t.snid].genes.push(e)})}else s[t.snid]=e}var o={},s={};Oe={},Fe={},ze={},De={},n.forEach(function(t){Fe[t]=0,De[t]={}}),r.forEach(function(t){ze[t.snid]=Number.POSITIVE_INFINITY}),r.forEach(function(r){var s={_id:r._id,name:r.name,snid:r.snid,genes:[],dataset:a[r._id]};if(!M[a[r._id]])return s.cooccurring=!1,void i(r,s);var l=[];n.forEach(function(n){var i=[];if(-1!=e[n].indexOf(r._id)){mutated=!1;var c=t[n][r._id].filter(function(t){return w[t]}).sort(function(t,e){return we[t]<we[e]?1:-1});if(c.forEach(function(t){s.genes.push({gene:n,dataset:a[r._id],ty:t,sample:r,mutTys:c}),mutated=!0,i.push(t),-1==l.indexOf(n)&&l.push(n)}),mutated){Fe[n]+=1,o[r.snid]=!0,ze[r.snid]=d3.min([ze[r.snid],ke[n]]);var d=d3.min(i.map(function(t){return we[t]}));De[n][r.snid]=d3.min([d,De[n][r.snid]])}}}),s.cooccurring=Oe[r.snid]=l.length>1,s.genes.forEach(function(t){t.cooccurring=s.cooccurring}),i(r,s)});var l=[];Object.keys(s).forEach(function(t){l.push(s[t])});var c=Object.keys(o).length;return{sampleMutations:l,coverage:c,geneToFreq:Fe,sampleToExclusivity:Oe,sampleToGeneIndex:ze,geneToSampleMutationType:De}}function r(t,e,n,r){function a(t,e){return d3.ascending(n[t.snid],n[e.snid])}function i(t,e){return d3.ascending(r[t.snid],r[e.snid])}function o(t,r){var a=n[t.snid],i=n[r.snid];if(a<e.length)var o=De[e[a]][t.snid];if(i<e.length)var s=De[e[i]][r.snid];return o>s?1:o==s?0:-1}function s(t,e){return d3.ascending(t.name,e.name)}function l(t,e){return d3.ascending(Q[t._id],Q[e._id])}var c={};return c[Te]=i,c[_e]=a,c[Se]=o,c[Ae]=s,c[Ce]=l,d3.range(0,ie).sort(function(e,n){var r,a=ae[e],i=ae[n];for(en=0;en<t.length;en++)if(r=c[t[en]](a,i),0!=r)return r;return r})}function p(){mutationData=n(K,xe,ne,ee,Q),Me=mutationData.sampleMutations,ze=mutationData.sampleToGeneIndex,Oe=mutationData.sampleToExclusivity,Fe=mutationData.geneToFreq,Ie=mutationData.coverage,De=mutationData.geneToSampleMutationType;var t=r(Le,be,ze,Oe);He={};for(var e=0;ie>e;e++)He[ae[t[e]].snid]=e}function b(t){return"del"==t}function N(t){return"amp"==t}function W(t){return"snv"==t}function G(t){return"other"==t}function P(t){return"inactive_snv"==t}function B(t){return"fus"==t}function R(){function t(t){return Ne(He[t])>=m+l&&Ne(He[t])<=fe}function e(e){return t(e.sample.snid)&&w[e.ty]&&M[Q[e.sample._id]]}var n=$e.filter(function(e){return t(e.snid)}).style("fill-opacity",1).style("stroke-opacity",1);$e.filter(function(e){return!t(e.snid)}).style("fill-opacity",.25).style("stroke-opacity",1),Ve.style("opacity",0).style("stroke-opacity",0),Ve.filter(function(t){return e(t)}).style("opacity",1).style("stroke-opacity",1),Ve.filter(function(t){return!e(t)&&w[t.ty]&&M[Q[t.sample._id]]}).style("opacity",.25).style("stroke-opacity",.25);var r=n[0].length,a=fe-m-l;for(le=1;4>le*a/r;)le+=1;se=a/r,Ye.attr("width",se).attr("y",function(t){var e=ke[t.gene]?ke[t.gene]:0;return(e+.375)*h}),Ue.attr("transform",function(t){var e=se/2,n=(ke[t.gene]?ke[t.gene]:0)*h+h/2,r=se/6,a="translate("+e+","+n+")",i="rotate(90)",o="scale("+r+")";return a+","+i+","+o}),rn.attr("x2",se).attr("transform",function(t){var e=(ke[t.gene]?ke[t.gene]:0)*h;return"translate(0,"+e+")"}),Be.attr("transform",function(t){return"translate("+Ne(He[t.snid])+")"}),Be.selectAll("text").style("font-size",8>se?se:8).attr("transform","translate("+se/2+","+g+"), rotate(-90)"),A.attr("width",se).attr("height",function(t){return b(t.ty)||N(t.ty)?h/2:h}).attr("y",function(t){var e=ke[t.gene]?ke[t.gene]:0,n=b(t.ty)?h/2:0;return t.y=e*h+n}),d3.select("rect#sampleWidthRect").attr("width",le*se-2*x);var i=1==le?"sample":"samples";if(d3.select("text#sampleWidthText").attr("transform","translate("+(se+5)+",0)").text(le+" "+i),j){{E.sampleToAnnotations,E.annotationToColor||{}}qe.each(function(t){var e=(t.name,d3.select(this));e.selectAll("rect").attr("width",se)})}je.selectAll(".vert-line").remove();var o=Be.data().map(function(t,e){return e}).filter(function(t){return Ne(t)>=m+l&&Ne(t)<=fe}).filter(function(t,e){return e%le==0});je.selectAll(".vert-line").data(o).enter().append("line").attr("x1",-pe).attr("y1",l).attr("y2",l).attr("class","vert-line").attr("transform",function(t){return"translate("+Ne(t)+","+(g+l)+"), rotate(-90)"}).style("stroke","#fff").style("stroke-width",x)}function X(){return(100*Ie/he).toFixed(2)+"% ("+Ie+"/"+he+")"}function V(){var e=t.append("span").style("float","right").style("margin-right",(O?de-un:0)+"px");e.append("b").text("Coverage: "),dn=e.append("span").text(X())}function q(t,e){var n=M[e],r=n?.5:1;d3.select(t).selectAll("*").style("fill-opacity",r).style("stroke-opacity",r),M[e]=!n,C()}function Y(){if(ce){var e=15,n=t.insert("svg","svg").attr("id","sample-type-legend").attr("width",de-un).attr("height",ue).style("float","right").style("margin-top",g+l).style("margin-left",un).style("margin-bottom",10).style("font-size",10);n.append("text").attr("x",2).attr("y",10).style("font-weight","bold").text("Sample Types");var r=n.selectAll(".dataset-legend").data(Z).enter().append("g").attr("transform",function(t,n){return"translate(2,"+(n+1)*e+")"}).style("cursor","pointer").on("click",function(t){q(this,t)});r.append("rect").attr("width",e).attr("height",e).style("fill",function(t){return k[t]}),r.append("text").attr("dy",e-3).attr("dx",20).text(function(t){return t})}}function U(){function e(t,e){var n=w[e],r=n?.5:1;d3.select(t).selectAll("*").style("fill-opacity",r).style("stroke-opacity",r),w[e]=!n,C()}var n=10,r=11,a=n/2,s=t.append("svg").attr("id","mutation-legend").attr("height",v).attr("width",fe).style("margin-left",m+l).append("g").style("font-size",r);ce||(s.append("rect").attr("x",a).attr("height",h).attr("width",n).style("fill",u),s.append("text").attr("x",n+10).attr("y",3*h/4).style("fill","#000").text("Exclusive"),a+=n+10+65,s.append("rect").attr("x",a).attr("height",h).attr("width",n).style("fill",d),s.append("text").attr("x",a+n+10).attr("y",3*h/4).style("fill","#000").text("Co-occurring"),a+=n+10+85);var c=s.append("g").attr("transform","translate("+a+",0)").style("cursor","pointer").on("click",function(){e(this,"snv")});a+=n+10+10+25;var f=s.append("g").attr("transform","translate("+a+",0)").style("cursor","pointer").on("click",function(){e(this,"inactive_snv")});a+=n+10+75;var p=s.append("g").attr("transform","translate("+a+",0)").style("cursor","pointer").on("click",function(){e(this,"del")});a+=n+10+55;var g=s.append("g").attr("transform","translate("+a+",0)").style("cursor","pointer").on("click",function(){e(this,"amp")});a+=n+10+75;var y=s.append("g").attr("transform","translate("+a+",0)").style("cursor","pointer").on("click",function(){e(this,"fus")});a+=n+10+220,c.append("rect").attr("height",h).attr("width",n).style("fill",o),c.append("text").attr("dx",n+10).attr("dy",3*h/4).style("fill","#000").text("SNV"),f.append("rect").attr("height",h).attr("width",n).style("fill",o),f.append("rect").attr("y",3*h/8).attr("height",h/4).attr("width",n).style("fill","#000"),f.append("text").attr("dx",n+10).attr("dy",3*h/4).style("fill","#000").text("Inactivating"),p.append("rect").attr("y",h/2).attr("height",h/2).attr("width",n).style("fill",o),p.append("text").attr("dx",n+5).attr("dy",3*h/4).style("fill","#000").text("Deletion"),g.append("rect").attr("height",h/2).attr("width",n).style("fill",o),g.append("text").attr("dx",n+10).attr("dy",3*h/4).style("fill","#000").text("Amplification"),y.append("path").attr("d",d3.svg.symbol().type("triangle-up").size(30)).attr("transform","translate(0,"+3*h/8+")rotate(90)").style("stroke",i).style("fill",o),y.append("text").attr("dx",n+10).attr("dy",3*h/4).style("fill","#000").text("Fusion/Rearrangement/Splice Variant"),s.append("rect").attr("x",a).attr("id","sampleWidthRect").attr("width",le*se-2*x).attr("height",h).style("fill",o),s.append("text").attr("id","sampleWidthText").attr("x",a).attr("y",3*h/4).attr("transform","translate("+(se+5)+",0)").style("fill","#000").text(1==le?"1 sample":le+" samples")}function J(){function e(t){for(var e=r(t,be,ze,Oe),n=0;ie>n;n++)He[ae[e[n]].snid]=n;Be.transition().duration(a).delay(function(t){return Ne(He[t.snid])}).attr("transform",function(t){return"translate("+Ne(He[t.snid])+",0)"}),i()}function n(t,n){var r=Le,a=Le.indexOf(t),i=a-n;-1!=i&&i<Le.length&&(r[a]=r[i],r[i]=t),e(r)}function i(){l.selectAll("*").remove();var t=l.selectAll(".sort-fn").data(Le).enter().append("li").style("list-style-type","none").style("margin-bottom","5px");t.append("span").style("cursor","pointer").html("&darr;").on("mouseover",function(){d3.select(this).style("color","red")}).on("mouseout",function(){d3.select(this).style("color","black")}).on("click",function(t){n(t,-1)}),t.append("span").style("cursor","pointer").html("&uarr;").on("mouseover",function(){d3.select(this).style("color","red")}).on("mouseout",function(){d3.select(this).style("color","black")}).on("click",function(t){n(t,1)}),t.append("span").text(function(t){Ee[t];return" "+Ee[t]})}var o=t.append("div").attr("id","sample-sorting-interface").style("margin-left",m+"px").style("font-size","12px"),s=o.append("a").style("font-weight","bold").text("Sort mutation matrix by: ").on("click",function(){$("ul#sample-sort-list").is(":visible")?($("ul#sample-sort-list").slideUp(),$("span#interface-status").html("&uarr;")):($("ul#sample-sort-list").slideDown(),$("span#interface-status").html("&darr;"))});s.append("span").attr("id","interface-status").style("cursor","pointer").html("&uarr;");var l=o.append("ul").attr("id","sample-sort-list").style("padding-left","10px").style("display","none");i()}var K=e.M||{},Q=e.sampleToTypes||{},Z=e.sampleTypes||[],te=e.typeToSamples||{},ee=e.samples;console.log(e);{var ne=Object.keys(K);ne.length}ee||(ee=Object.keys(Q).map(function(t){return{_id:t,name:t,z_index:1}})),ee.forEach(function(t){t.snid=I?t._id:t.name});var re={};ee.sort(function(t,e){return d3.ascending(t.z_index,e.z_index)}),ee.forEach(function(t){re[t.snid]||(re[t.snid]=t)});var ae=[];Object.keys(re).forEach(function(t){ae.push(re[t])});for(var ie=ae.length,oe=0;oe<ee.length;oe++)-1==Z.indexOf(Q[ee[oe]._id])&&Z.push(Q[ee[oe]._id]);Z.sort(),Z.forEach(function(t){M[t]=!0});var se,le,ce=Z.length>1&&c,de=ce?100:0,ue=ce?15*(Z.length+1):0,fe=f-(O?de:0),pe=ne.length*h+l;if(I)var he=Z.reduce(function(t,e){return t+te[e].length},0);else{var ge={};Z.forEach(function(t){te[t].forEach(function(t){ge[t]=!0})});var he=Object.keys(ge).length}var me=Z.reduce(function(t,e){return k[e]?t+1:t},0);if(me!=Z.length)for(var ye=d3.scale.category20(),oe=0;oe<Z.length;oe++)k[Z[oe]]||(k[Z[oe]]=ye(oe));if(j){var ve=Object.keys(E.sampleToAnnotations)[0];numAnnTypes=E.sampleToAnnotations[ve].length,pe+=numAnnTypes*h}var xe={};for(oe=0;oe<ne.length;oe++)xe[ne[oe]]=Object.keys(K[ne[oe]]);var ke={},be=ne.sort(function(t,e){return xe[t].length<xe[e].length?1:-1});d3.range(0,ne.length).forEach(function(t){ke[be[t]]=t});var we={fus:0,inactive_snv:1,snv:2,amp:3,del:4,other:5},Ce=0,Ae=1,Se=2,Te=3,_e=4,Ee={};Ee[Te]="Exclusivity",Ee[_e]="Gene frequency",Ee[Se]="Mutation type",Ee[Ae]="Sample name",Ee[Ce]="Sample type";var Me,ze,Oe,He,Fe,De,Ie,Le=[_e,Ce,Te,Se,Ae];p();var je=d3.select(this).selectAll("svg").data([e]).enter().append("svg"),Ne=d3.scale.linear().domain([0,ie]).range([m+l,fe-l]),We=d3.behavior.zoom().x(Ne).scaleExtent([1,Math.round(y*ie/fe)]).on("zoom",function(){R()});je.attr("id","mutation-matrix").attr("width",fe).attr("height",pe+g).attr("xmlns","http://www.w3.org/2000/svg").call(We);var Ge=je.append("g").attr("transform","translate("+l+","+l+")");Ge.append("rect").style("fill",i).attr("width",fe-m-l).attr("height",pe).attr("transform","translate("+(m+l)+","+g+")");var Pe=Ge.append("svg:g").attr("id","mutation-matrix"),Be=Pe.selectAll(".sample").data(Me).enter().append("svg:g").attr("class","sample").attr("id",function(t){return t.name});Be.append("text").attr("fill",o).attr("text-anchor","start").text(function(t){return t.name});var Re=Ge.selectAll(".geneLabels").data(ne).enter().append("svg:g").attr("class","geneLabel").attr("transform",function(t){return"translate(0,"+(g+ke[t]*h)+")"}),Xe=Re.append("text").attr("class","gene-name").attr("font-size",14).attr("text-anchor","end").attr("transform",function(){return"translate("+m+","+(h-l)+")"}).text(function(t){return t+" ("+Fe[t]+")"});Ge.selectAll(".horizontal-line").data(ne).enter().append("line").attr("x2",fe-m).attr("transform",function(t,e){var n=m+l,r=g+e*h;return"translate("+n+","+r+")"}).style("stroke","#fff");var $e=Be.append("g").attr("transform","translate(0,"+g+")"),Ve=$e.selectAll(".muts").data(function(t){return t.genes}).enter().append("g");A=Ve.append("rect").attr("class",function(t){return"tick "+t.ty}).attr("fill",function(t){return ce?B(t.ty)&&W(t.ty)?i:k[t.dataset]:B(t.ty)&&W(t.ty)?i:t.cooccurring?d:u});var qe,Ye=Ve.append("rect").filter(function(t){return P(t.ty)}).attr("class","inactivating").attr("width",se).attr("height",h/4).style("fill",s),Ue=Ve.append("svg:path").filter(function(t){return B(t.ty)}).attr("class","fusion").attr("d",d3.svg.symbol().type("triangle-up").size(8)).style("stroke-opacity",0).style("fill",function(t){return ce?k[t.dataset]:t.cooccurring?d:u}),Je=[];if(j){var Ke=h*ne.length+g,Qe=E.sampleToAnnotations,Ze=E.annotationToColor||{};qe=Be.append("g").attr("transform","translate(0,"+Ke+")");for(var tn=[],oe=0;oe<Qe[Object.keys(Qe)[0]].length;oe++)tn.push(null);for(var en in Object.keys(Qe)){var nn=Object.keys(Qe)[en],e=Qe[nn];e.forEach(function(t,e){"number"==typeof t&&(null==tn[e]?(tn[e]={},tn[e].min=t,tn[e].max=t):(tn[e].min=t<tn[e].min?t:tn[e].min,tn[e].max=t>tn[e].max?t:tn[e].max))})}tn.forEach(function(t){null==t?Je.push(null):(scale=d3.scale.linear().domain([t.min,t.max]).range(["#fcc5c0","#49006a"]).interpolate(d3.interpolateLab),Je.push(scale))}),qe.each(function(t){var e=t.name,n=d3.select(this);Qe[e]&&n.selectAll("rect").data(Qe[e]).enter().append("rect").attr("height",h).attr("x",0).attr("y",function(t,e){return h*e}).style("fill",function(t,e){return"number"==typeof t?Je[e](t):Ze[t]})})}var rn=Ve.append("line").filter(function(t){return G(t.ty)}).attr("class","other").attr("x1",function(){return 0}).attr("y1",function(){return 0}).attr("y2",function(){return h}).style("stroke","#000").style("stroke-width",2);if(D){T=d3.tip().attr("class","d3-tip").offset([-10,0]).html(S),je.call(T);var an="div.m2-tooltip",on=function(t,e){d3.select(an+" div.more-info").style("display",t?"inline":"none"),d3.select(an+" div.less-info").style("display",e?"inline":"none")},sn=function(t){T.hide(t),d3.select(this).on("mouseout",function(){T.hide(t)}),on(!1,!0)},ln=function(t){T.show(t),d3.select(an).insert("span",":first-child").style("cursor","pointer").style("float","right").attr("class","x").on("click",sn).text("X")},cn=function(t){ln(t),on(!0,!1)};Ve.on("mouseover",ln).on("mouseout",T.hide).on("click",function(t){cn(t),d3.select(this).on("mouseout",cn),L&&_(t,oe)})}else L&&Ve.on("click",_);var dn,un=10;C=function(){p(),Xe.text(function(t){return t+" ("+Fe[t]+")"}),dn.text(X()),R()},R(),z&&V(),O&&Y(),H&&U(),F&&J()})}var t=t||{},n=t.style||{},r=n.colorSchemes||{},a=n.animationSpeed||300,i=n.bgColor||"#F6F6F6",o=n.blockColorMedium||"#95A5A6",s=n.blockColorStrongest||"#2C3E50",l=n.boxMargin||5,c=n.colorSampleTypes||!0,d=n.coocurringColor||"orange",u=n.exclusiveColor||"blue",f=n.width||500,p=n.height||300,h=n.geneHeight||20,g=n.labelHeight||40,m=n.labelWidth||100,y=n.minBoxWidth||20,v=n.mutationLegendHeight||30,x=n.sampleStroke||1,k=r.sampleType||{},b=t.mutationTypes||["snv","inactive_snv","del","amp","fus","other"],w={};b.forEach(function(t){w[t]=!0});var C,A,S,T,_,E,M={},z=!1,O=!1,H=!1,F=!1,D=!1,I=!1,L=!1,j=!1;return e.addCoverage=function(){return z=!0,e},e.addSampleLegend=function(){return O=!0,e},e.addMutationLegend=function(){return H=!0,e},e.addSortingMenu=function(){return F=!0,e},e.addSampleAnnotations=function(t){return E=t,j=!0,e},e.showDuplicates=function(){return I=!0,e},e.width=function(t){return arguments.length?(f=t,e):width},e.height=function(t){return arguments.length?(p=t,e):height},e.filterDatasets=function(t){Object.keys(t).forEach(function(e){M[e]=t[e]}),C()},e.addTooltips=function(t){return D=!0,S=t,A&&T&&T.html(t),e},e.addOnClick=function(t){return L=!0,_=t,e},e}function transcript_plot(t){function e(t){t.each(function(e){function n(){var n=Object.keys(v),r=n.length,a=Math.ceil(r/2),i=a*legendSymbolHeight,s=t.append("div").selectAll("svg").data([e]).enter().append("svg").attr("class","legend").attr("font-size",10).style("height",i+2*margin).style("width",width),l=s.selectAll(".symbolGroup").data(n).enter().append("g").attr("transform",function(t,e){var n=e%a*width/a+2*margin,i=Math.round(e/r)*legendSymbolHeight+(Math.round(e/r)+2)*margin;return"translate("+n+", "+i+")"}).style("cursor","pointer").on("click",function(t){var e=x[t],n=e?.5:1;d3.select(this).selectAll("*").style("fill-opacity",n).style("stroke-opacity",n),x[t]=!e,k()});l.append("path").attr("class","symbol").attr("d",d3.svg.symbol().type(function(t){return d3.svg.symbolTypes[v[t]]}).size(2*legendSymbolHeight)).style("stroke",o).style("stroke-width",2).style("fill",o),l.append("text").attr("dx",7).attr("dy",3).text(function(t){return t.replace(/_/g," ")})}function r(){function t(t,e,n){t.attr("cy",e.y=n),e.z.translate([e.z.translate()[0],"up"==e.direction?e.scale(e.y):-e.scale(e.y)]),k()}function e(t,e){return"up"==t.direction?Math.max(t.y2,Math.min(t.y1,e)):Math.max(t.y1,Math.min(t.y2,e))}function n(n){d3.select(this).attr("opacity",.6),t(d3.select(this),n,e(n,d3.event.y))}function r(){d3.select(this).attr("opacity",1)}var a=5,i=8,o=5,s=4,l=D-2*i-2*margin;sliderRadius=4,sliderWidth=3,sliderMargin=margin+i;var c=[{x:margin,y1:sliderMargin+l,y2:sliderMargin,direction:"up",z:q,scale:V,name:"topSlider"},{x:margin,y1:height-sliderMargin-l,y2:height-sliderMargin,direction:"down",z:J,scale:U,name:"bottomSlider"}];c.forEach(function(t){t.y=t.y1,t.scale.domain([t.y1,t.y2])});var u=[{y:margin,increment:-a,symbol:o,slider:c[0]},{y:sliderMargin+2*margin+l,increment:a,symbol:s,slider:c[0]},{y:height-l-sliderMargin-2*margin,increment:-a,symbol:o,slider:c[1]},{y:height-margin,increment:a,symbol:s,scale:U,slider:c[1]}];I.selectAll(".button").data(u).enter().append("path").attr("d",d3.svg.symbol().type(function(t){return d3.svg.symbolTypes[t.symbol]}).size(radius*radius)).attr("transform",function(t){return"translate("+margin+","+t.y+")"}).style("cursor","pointer").style("fill",d).on("click",function(n){var r=e(n.slider,n.slider.y+n.increment);t(d3.select("circle#"+n.slider.name),n.slider,r)});var f=d3.behavior.drag().origin(Object).on("drag",n).on("dragend",r),p=I.selectAll(".slider").data(c).enter().append("g");p.append("line").attr("x1",function(t){return t.x}).attr("x2",function(t){return t.x}).attr("y1",function(t){return t.y1}).attr("y2",function(t){return t.y2}).style("stroke","#C0C0C0").style("stroke-width",2),p.append("circle").attr("id",function(t){return t.name}).attr("r",sliderRadius).attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y1}).attr("fill","#C0C0C0").style("cursor","pointer").call(f)}var T=e.gene,_=e.length,E=e.mutations,M=e.domains[a]||[],z=E.slice().map(function(t){return t.gene=T,t}),O=[];if(E.forEach(function(t){-1==O.indexOf(t.dataset)&&O.push(t.dataset)}),O.sort(),O.forEach(function(t){S[t]=!0}),0==Object.keys(A).length)for(var H=d3.scale.category20(),F=0;F<O.length;F++)A[O[F]]=H(F);var D=(height-genomeHeight-axisHeight-4*margin)/2,I=d3.select(this).selectAll("svg").data([e]).enter().append("svg").style("cursor","move");I.attr("class","transcript-box").attr("id",T+"-transcript").attr("width",width).attr("height",height+2*margin);var L=I.append("g"),j=(L.append("rect").attr("class","background").attr("width",width).attr("height",height).style("fill",c),D),N=(L.append("rect").attr("class","background").attr("id","background-top").attr("width",width-2*margin).attr("height",D).attr("x",margin).attr("y",margin).style("fill",c),D+genomeHeight+axisHeight+3.5*margin),W=(L.append("rect").attr("class","background").attr("id","background-bottom").attr("width",width-2*margin).attr("height",D).attr("x",margin).attr("y",D+genomeHeight+axisHeight+3*margin).style("fill",c),0),G=_,P=d3.scale.linear().domain([W,G]).range([margin,width-margin]),B=d3.behavior.zoom().x(P).scaleExtent([1,100]).on("zoom",function(){k()});L.call(B);var R=2*radius,X=E.length,$=d3.scale.linear().domain([0,X]).range([D,-1*R*X+j]),V=d3.scale.linear().range([0,R*X]),q=d3.behavior.zoom().y($).scaleExtent([1,1]).on("zoom",function(){k()}),Y=d3.scale.linear().domain([0,X]).range([N,N+X*R]),U=d3.scale.linear().range([0,R*X]),J=d3.behavior.zoom().y(Y).scaleExtent([1,1]).on("zoom",function(){k()}),K=2*margin+D,Q=L.append("rect").attr("class","transcript").attr("height",genomeHeight-margin).attr("width",P(G)-P(W)).attr("x",P(W)).attr("y",K+margin/2).style("fill",i),Z=d3.svg.axis().scale(P).orient("bottom").ticks(numTicks).tickSize(0).tickPadding(tickPadding),te=L.append("g").attr("class","xaxis").attr("transform","translate(5,"+(K+genomeHeight+margin)+")").style("font-size","12px").style("fill","#000").call(Z),ee=L.selectAll(".top-symbols").data(z.filter(function(t){return!y[t.ty]})).enter().append("path").attr("class","symbols").attr("d",d3.svg.symbol().type(function(t){return d3.svg.symbolTypes[v[t.ty]]}).size(radius*radius)).style("fill",function(t){return A[t.dataset]}).style("stroke",function(t){return A[t.dataset]}).style("stroke-width",2).style("cursor","default"),ne=L.selectAll(".bottom-symbols").data(z.filter(function(t){return y[t.ty]})).enter().append("path").attr("class","symbols").attr("d",d3.svg.symbol().type(function(t){return d3.svg.symbolTypes[v[t.ty]]}).size(radius*radius)).style("fill",function(t){return A[t.dataset]}).style("stroke",function(t){return A[t.dataset]}).style("stroke-width",2).style("cursor","default");if(h){var re=d3.tip().attr("class","d3-tip").offset([-10,0]).html(b);I.call(re),ne.on("mouseover",re.show).on("mouseout",re.hide),ee.on("mouseover",re.show).on("mouseout",re.hide),g&&(ne.on("click",function(t,e){w(t,e)}),ee.on("click",function(t,e){w(t,e)}))}else g&&(ee.on("click",w),ne.on("click",w));var M=M.map(function(t){return t.gene=T,t}),ae=L.selectAll(".domains").data(M).enter().append("g").attr("class","domains"),ie=ae.append("rect").attr("id",function(t,e){return"domain-"+e}).attr("width",function(t){return P(t.end)-P(t.start)}).attr("height",genomeHeight+margin).style("fill",o).style("fill-opacity",.5),oe=ae.append("text").attr("id",function(t,e){return"domain-label-"+e}).attr("text-anchor","middle").attr("y",genomeHeight).style("fill",l).style("fill-opacity",0).text(function(t){return t.name});ae.on("mouseover",function(t,e){d3.select(this).selectAll("rect").style("fill",s),L.select("#domain-label-"+e).style("fill-opacity",1)}).on("mouseout",function(t,e){d3.select(this).selectAll("rect").style("fill",o),L.select("#domain-label-"+e).style("fill-opacity",0)}),m&&ae.on("click",C),k=function(){function t(t,e,n,r,s){var l={};t.filter(function(t){return x[t.ty]&&S[t.dataset]}).each(function(t){var e=Math.round(t.locus/o);e in l?(yIndex=l[e],l[e]+=1):(yIndex=0,l[e]=1),t.x=P(e*o),t.y=n(yIndex)}),X=d3.max(Object.keys(l),function(t){return l[t]}),e.range([0,R*X]),t.attr("transform",function(t){return"translate("+t.x+", "+t.y+")"}).style("fill-opacity",1).style("stroke-opacity",1),t.filter(function(t){var e=r<t.y&&s>t.y&&a<t.locus&&i>t.locus,n=x[t.ty],o=S[t.dataset];return!(e&&n&&o)}).style("fill-opacity",0).style("stroke-opacity",0)}var e=B.translate(),n=(B.scale(),e[0]),r=e[1];n=Math.min(n,0),B.translate([n,r]);var a=d3.min(P.domain()),i=d3.max(P.domain()),o=Math.round((i-a)/u);o=o?o:1,t(ee,V,$,0,D+margin),t(ne,U,Y,N-margin,height-2*margin),te.call(Z),Q.attr("x",P(W)).attr("width",P(G)-P(W)),ae.attr("transform",function(t){return"translate("+P(t.start)+","+(K-margin/2)+")"}),ie.attr("width",function(t){return P(t.end)-P(t.start)}),oe.attr("x",function(){var t=d3.select(this.parentNode).select("rect").attr("width");return t/2})},k(),f&&n(),p&&r()})}var t=t||{},n=t.style||{},r=n.colorSchemes||{},a=t.domainDB||"PFAM",i=n.blockColorLight||"#BDC3C7",o=n.blockColorMedium||"#95A5A6",s=n.highlightColor||"#f1c40f",l=n.textColorStrongest||"#2C3E50",c=n.bgColor||"#ffffff",d=n.buttonColor||"#666666";genomeHeight=n.genomeHeight||20,axisHeight=n.axisHeight||20,height=n.height||200,margin=n.margin||5,numTicks=n.numTicks||5,radius=n.radius||5,legendSymbolHeight=n.legendSymbolHeight||14,tickPadding=n.tickPadding||1.25,width=n.width||500;var u=Math.floor(width/(2*radius)),f=!1,p=!1,h=!1,g=!1,m=!1,y=t.inactivating||{Nonsense_Mutation:!0,Frame_Shift_Del:!0,Frame_Shift_Ins:!0,Missense_Mutation:!1,Splice_Site:!0,In_Frame_Del:!1,In_Frame_Ins:!1},v=t.mutSymbols||{Nonsense_Mutation:0,Frame_Shift_Del:1,Frame_Shift_Ins:1,Missense_Mutation:2,Splice_Site:3,In_Frame_Del:4,In_Frame_Ins:4},x={};Object.keys(v).forEach(function(t){x[t]=!0});var k,b,w,C,A=r.sampleType||{},S={};return e.addLegend=function(){return f=!0,e},e.addTooltips=function(t){return h=!0,b=t,e},e.addOnClickMutations=function(t){return g=!0,w=t,e},e.addOnClickDomains=function(t){return m=!0,C=t,e},e.addVerticalPanning=function(){return p=!0,e},e.filterDatasets=function(t){Object.keys(t).forEach(function(e){S[e]=t[e]}),k()},e}function subnetwork(t){function e(t){t.each(function(t){function e(){var t=w?b-Math.max(f+15,v):b-v,e=M.selectAll(".net-group").data(I).enter().append("g").attr("transform",function(e,n){return"translate("+t+","+(n+1)*y+")"}).style("font-size",12).on("click",function(t){var e=P[t];P[t]=!e,e||G[t].style("display","inline"),G[t].transition().duration(k).style("stroke-opacity",e?0:1),e&&setTimeout(function(){G[t].style("display","none")},k),d3.select(this).transition().duration(k).style("stroke-opacity",e?.5:1).style("fill-opacity",e?.5:1),A?(W.filter(function(t){return t.networks.reduce(function(t,e){return t+(P[e]?1:0)},0)>0}).on("mouseover",q).on("mouseout",$.hide).on("click",function(t,e){q(t),d3.select(this).on("mouseout",q),S&&n(t,e)}),W.filter(function(t){return 0==t.networks.reduce(function(t,e){return t+(P[e]?1:0)},0)}).on("mouseover",function(){}).on("mouseout",function(){})):S&&W.filter(function(t){return 0==t.networks.reduce(function(t,e){return t+(P[e]?1:0)},0)}).on("click",n)});e.append("line").attr("x1",0).attr("x2",y).style("stroke-width",s).style("stroke",function(t){return i.network[t]}),e.append("text").attr("x",8+y).attr("y",3).text(function(t){return t})}function a(){var t=w?18*I.length+15:10,e=w?b-Math.max(f+15,v):b-f-15,n=M.append("g").attr("id","subnetwork-legend").attr("transform","translate("+e+","+t+")");M.append("svg:defs").append("svg:linearGradient").attr("x1","0%").attr("y1","100%").attr("x2","0%").attr("y2","0%").attr("id","heat_gradient").call(function(t){t.append("svg:stop").attr("offset","0%").attr("style","stop-color:"+o+";stop-opacity:1"),t.append("svg:stop").attr("offset","100%").attr("style","stop-color:"+g+";stop-opacity:1")}),n.append("rect").attr("y",5).attr("width",f).attr("height",u).style("fill","url(#heat_gradient)"),n.append("text").attr("dx",f/2).attr("text-anchor","middle").text(d3.max(z)),n.append("text").attr("dx",f/2).attr("dy",u+20).attr("text-anchor","middle").text(d3.min(z)),n.append("text").attr("dx",(u+10)/2).attr("dy",-f-5).attr("text-anchor","middle").attr("transform","rotate(90)").text(p)}function T(t,e){for(var n=[],r=0;r<e.length;r++)for(var a=e[r].name,i=0;i<e.length;i++)for(var o=e[i].name,s=0;s<t.length;s++){var l=t[s].source,c=t[s].target;(a==l&&o==c||a==c&&o==l)&&n.push({source:e[r],target:e[i],weight:t[s].weight,networks:t[s].networks,references:t[s].references})}return n}var _=t.edges,E=t.nodes,M=d3.select(this).selectAll("svg").data([t]).enter().append("svg");M.attr("id","figure").attr("height",h+m.top+m.bottom).attr("width",b).style("font-family",c).style("font-size",d);var z=E.map(function(t){return t.heat}),O=d3.scale.linear().domain([d3.min(z),d3.max(z)]).range([o,g]).nice(),H=b;w&&C?H-=Math.max(v,f):w?H-=v:C&&(H-=f);var F=d3.layout.force().charge(-400).linkDistance(40).size([H,h]),D=(F.drag().on("dragstart",function(t){t.fixed=!0,d3.select(this).select("circle").style("stroke-opacity",0)}),d3.scale.linear().range([0,H]),d3.scale.linear().range([0,h]),T(_,E));F.nodes(E).links(D).start();for(var I=[],L=0;L<D.length;L++)for(var j=0;j<D[L].networks.length;j++)-1==I.indexOf(D[L].networks[j])&&I.push(D[L].networks[j]);for(var N=I.length,W=M.selectAll(".link").data(D).enter().append("g"),G={},P={},L=0;L<I.length;L++){var B=I[L],R=i.network[I[L]];P[B]=!0;var X=W.filter(function(t){return t.networks&&-1!=t.networks.indexOf(B)}).append("line").classed(B,!0).style("stroke-width",s).style("stroke",R);G[B]=X}if(A){var $=d3.tip().attr("class","d3-tip").offset([-10,10]).html(function(t){return r(t,P)});M.call($);var V=function(t){$.hide(t),d3.select(this).on("mouseout",function(){$.hide(t)})},q=function(t){$.show(t),d3.select("div#subnet-tooltip").insert("span",":first-child").style("cursor","pointer").style("float","right").attr("class","x").on("click",V).text("X")};W.on("mouseover",q).on("mouseout",$.hide).on("click",function(t,e){q(t),d3.select(this).on("mouseout",q),S&&n(t,e)})}else S&&W.on("click",n);var Y=M.append("svg:g").selectAll("node").data(E).enter().append("svg:g").style("cursor","move").call(F.drag).on("dblclick",function(t){t.fixed=t.fixed?!1:!0,d3.select(this).select("circle").style("stroke-opacity",1)});Y.append("circle").attr("r",x).attr("fill",function(t){return O(t.heat)}).style("stroke-width",1.5).style("stroke","#333"),Y.append("text").attr("x",x).attr("y","10px").style("fill",l).style("fill-opacity","1").style("font-size",d).text(function(t){return t.name}),F.on("tick",function(){Y.attr("transform",function(t){return t.x=Math.max(x,Math.min(H-x,t.x)),t.y=Math.max(x,Math.min(h-x,t.y)),"translate("+t.x+","+t.y+")"}),I.forEach(function(t,e){var n=s*(e-N/2);G[t].attr("x1",function(t){return t.source.x+n}).attr("y1",function(t){return t.source.y+n}).attr("x2",function(t){return t.target.x+n}).attr("y2",function(t){return t.target.y+n})})}),w&&e(),C&&a()})}var n,r,t=t||{},a=t.style||{},i=a.colorSchemes||{},o=a.cold||"rgb(102, 178, 255)",s=a.edgeWidth||1.5,l=a.fontColor||"#333",c=a.fontFamily||'"Helvetica","Arial"',d=a.fontSize||12,u=a.heatLegendHeight||110,f=a.heatLegendWidth||50,p=a.heatLegendText||"No. Mutated Samples",h=a.height||350,g=a.hot||"rgb(255, 51, 51)",m=a.margins||{bottom:0,left:0,right:0,top:0},y=a.netLegendBox||15,v=a.netLegendWidth||100,x=a.nodeRadius||10,k=a.transitionTime||500,b=a.width||350,w=!1,C=!1,A=!1,S=!1;return void 0==i.network&&(i.network={Multinet:"rgb(92, 128, 178)",iRefIndex:"rgb(140, 91, 56)",HINT:"rgb(127, 92, 159)","HINT+HI2012":"rgb(127, 92, 159)"}),e.addNetworkLegend=function(){return w=!0,e},e.addGradientLegend=function(){return C=!0,e},e.addTooltips=function(t){return A=!0,r=arguments.length?t:function(t,e){function n(t){return"<li><a href='http://www.ncbi.nlm.nih.gov/pubmed/"+t+"' target='_new'>"+t+"</a></li>"}var r="<div id='subnet-tooltip'>\n";return r+="Source: "+t.source.name+"<br/>Target: "+t.target.name+"<br/><br/>",r+="<table class='table table-condensed'>\n<tr><th>Network</th><th>PMIDs</th></tr>\n",t.networks.filter(function(t){return e[t]}).forEach(function(e){var a=t.references[e].map(n).join("\n");r+="<tr><td>"+e+"</td><td><ul style='padding-left:10px'>"+a+"</td></ul></tr>\n"}),r+"</table>\n</div>\n"},e},e.addOnClick=function(t){return S=!0,n=t,e},e}function cna_browser(t){function e(t){t.each(function(t){function e(){if(genome=G.append("rect").attr("class","genome").attr("y",b+(y-10)/2).attr("x",0).attr("width",m).attr("height",y-10).style("fill",l),geneGroups=G.selectAll(".genes").data(I).enter().append("g").attr("class","genes"),genes=geneGroups.append("rect").attr("width",function(t){return X(t.end)-X(t.start)
}).attr("height",y).style("fill-opacity",function(t){return t.selected?1:.2}).style("fill",function(t){return t.selected?d:s}).attr("id",function(t,e){return"gene-"+e}),geneLabels=geneGroups.append("text").attr("id",function(t,e){return"gene-label-"+e}).attr("y",b+5+y/2).attr("text-anchor","middle").style("fill-opacity",function(t){return t.selected?1:0}).style("fill",u).text(function(t){return t.label}),geneGroups.on("mouseover",function(t){t.fixed||(d3.select(this).select("rect").style("fill",c),d3.select(this).select("text").style("fill-opacity",1))}).on("mouseout",function(t){t.fixed||(d3.select(this).select("rect").style("fill",function(t){return t.selected?d:s}),d3.select(this).select("text").style("fill-opacity",0))}).on("dblclick",function(t){t.fixed=t.fixed?!1:!0,t.fixed&&(d3.select(this).select("rect").style("fill",function(t){return t.selected?d:c}),d3.select(this).select("text").style("fill-opacity",1))}),intervals=G.selectAll(".intervals").data(j).enter().append("g").attr("class","intervals"),ints=intervals.append("rect").attr("fill",function(t){return S[h[t.sample]]}).attr("width",function(t){return X(t.end,H,F)-X(t.start,H,F)}).attr("height",5).attr("id",function(t,e){return"interval-"+e}),verticalBars=G.selectAll(".vert-bar").data(I.filter(function(t){return t.selected})).enter().append("rect").attr("y",x).attr("width",function(t){return X(t.end)-X(t.start)}).attr("height",D-x).style("fill",d).style("fill-opacity",.5),C){var t=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(t){return t.sample+"<br/>Type: "+h[t.sample]+"<br/>Start: "+t.start+"<br/>End:    "+t.end});G.call(t),intervals.on("mouseover",function(e){t.show(e),$("div.d3-tip").css("left",d3.event.pageX-50+"px").css("top",d3.event.pageY-65+"px")}).on("mouseout",t.hide),A&&intervals.on("click",r)}else A&&intervals.on("click",r)}function a(){genes.attr("transform",function(t){return"translate("+X(t.start)+","+b+")"}),genes.attr("width",function(t){return X(t.end)-X(t.start)}),geneLabels.attr("transform",function(t){d3.max([t.start,d3.max(X.domain())]),d3.min([t.end,d3.min(X.domain())]);return"translate("+X(t.start+(t.end-t.start)/2)+",0)"}),verticalBars.attr("x",function(t){return X(t.start)}).attr("width",function(t){return X(t.end)-X(t.start)})}function i(){ints.attr("transform",function(t){return"translate("+X(t.start)+","+(b-15+t.y)+")"}).attr("width",function(t){return X(t.end)-X(t.start)});intervals.filter(function(t){return T[h[t.sample]]}).style("opacity",1);intervals.filter(function(t){return!T[h[t.sample]]}).style("opacity",0)}var h=t.sampleToTypes||{},_=t.gene||"",E=t.neighbors||[],M=t.segments||[],z=t.region||{},O=z.chr,H=z.minSegX,F=z.maxSegX,D=v*t.segments.length+x+b-10,I=E.map(function(t){var e=t.name==_;return{fixed:e?!0:!1,start:t.start,end:t.end,label:t.name,selected:e}}),L=new Array,j=new Array,N=new Array;M.forEach(function(t){L.push(t.sample),t.segments.forEach(function(e){j.push({gene:_,start:e.start,end:e.end,label:e.sample,sample:t.sample,dataset:h[t.sample],ty:e.ty}),N.indexOf(h[t.sample])&&N.push(h[e.sample])})}),j.sort(function(t,e){return t.dataset!=e.dataset?d3.ascending(t.dataset,e.dataset):d3.ascending(t.end-t.start,e.end-e.start)});var W=x;d3.range(0,j.length).forEach(function(t){j[t].y=W+=v}),N.sort(),N.forEach(function(t){T[t]=!0});var G=d3.select(this).selectAll("svg").data([t]).enter().append("svg"),P=z.minSegX,B=z.maxSegX,R=d3.scale.linear().domain([P,B]).range([0,m]),X=(d3.svg.axis().scale(R).orient("bottom").ticks(5).tickSize(0).tickPadding(1.25),d3.scale.linear().domain([P,B]).range([0,m])),V=d3.behavior.zoom().x(R).scaleExtent([1,100]).on("zoom",function(){n()});G.attr("id","cna-browser").attr("height",D+g.top+g.bottom).attr("width",m).style("display","block").style("font-family",f).style("font-size",p).call(V).on("dblclick.zoom",null);var q=(G.append("rect").attr("width",m).attr("height",D).attr("class","background").style("fill",o),G.append("text").attr("x",3).attr("y",k).style("font-size",w));n=function(){{var t=V.translate(),e=t[0],n=t[1];V.scale()}e=Math.min(e,0),V.translate([e,n]);var r=d3.min(R.domain()),o=d3.max(R.domain());X.domain([r,o]),q.text("chr"+O+": "+d3.round(r)+"-"+d3.round(o)),a(r,o),i(r,o)},e(),n()})}var n,r,t=t||{},a=t.style||{},i=a.colorSchemes||{},o=a.bgColor||"#F6F6F6",s=(a.blockColorStrongest||"#2C3E50",a.blockColorStrong||"#7F8C8D",a.blockColorMedium||"#95A5A6"),l=a.blockColorLight||"#BDC3C7",c=(a.blockColorLightest||"#ECF0F1",a.highlightColor||"#f1c40f"),d=a.selectedColor||"#E74C3C",u=a.textColorStrongest||"#2C3E50",f=(a.textColorStrong||"#34495E",a.textColorLight||"#BDC3C7",a.textColorLightest||"#ECF0F1",a.fontColor||"#333",a.fontFamily||'"Helvetica","Arial"'),p=a.fontSize||10,h=a.height||250,g=a.margins||{bottom:0,left:0,right:0,top:0},m=a.width||800,y=a.genomeHeight||25,v=a.intervalH||7,x=a.initIntervalH||50,k=a.rangeLegendY||15,b=a.rangeLegendOffset||25,w=a.rangeLegendFontSize||11,C=!1,A=!1,S=i.sampleType||{},T={};return e.width=function(t){return arguments.length?(fullWidth=t,e):m},e.height=function(t){return arguments.length?(fullHeight=t,e):h},e.addTooltips=function(){return C=!0,e},e.filterDatasets=function(t){Object.keys(t).forEach(function(e){T[e]=t[e]}),n()},e.addOnClick=function(t){return A=!0,r=t,e},e}
//# sourceMappingURL=dist/js/gd3.min.js.map